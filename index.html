<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halal Food Authority - Staff Feedback</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/image/HFA logo.jpeg" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            background-image: linear-gradient(to bottom, #f5f9fc, #e8f0f7);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background-color: #1a5f23;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            margin-top: 15px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-img {
            max-width: 120px;
            max-height: 120px;
            background-color: white;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo-fallback {
            background-color: white;
            color: #1a5f23;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid white;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a5f23;
        }
        
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #1a5f23;
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }
        
        .char-count {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .char-count.limit-reached {
            color: #d32f2f;
        }
        
        .feedback-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eaeaea;
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }
        
        .submit-btn {
            background-color: #1a5f23;
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover:not(:disabled) {
            background-color: #13461a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 95, 35, 0.2);
        }
        
        .submit-btn:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .submit-btn.error {
            background-color: #d32f2f;
        }
        
        .add-feedback-btn {
            background-color: #f0f7f1;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 12px 20px;
            font-size: 0.95rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 10px 0 20px 0;
            width: 100%;
        }
        
        .add-feedback-btn:hover {
            background-color: #e1f0e3;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(26, 95, 35, 0.1);
        }
        
        .required {
            color: #d32f2f;
        }
        
        .hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .thank-you-message {
            display: none;
            background-color: #f1f8e9;
            border-left: 5px solid #1a5f23;
            padding: 25px;
            margin-top: 30px;
            border-radius: 8px;
        }
        
        .thank-you-message h3 {
            color: #1a5f23;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .thank-you-message h3 i {
            font-size: 1.8rem;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #fafafa;
        }
        
        .form-instructions {
            background-color: #f8fdf9;
            border: 1px solid #d4ecd8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        
        .form-instructions h4 {
            color: #1a5f23;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hidden-feedback {
            display: none;
        }
        
        .remove-feedback-btn {
            background-color: #fef2f2;
            color: #d32f2f;
            border: 1px solid #fecaca;
            padding: 8px 15px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .remove-feedback-btn:hover {
            background-color: #fee2e2;
        }
        
        .error-message {
            background-color: #fef2f2;
            border-left: 5px solid #d32f2f;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .error-message h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* API Data Display Section */
        .api-data-section {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8fdf9;
            border: 1px solid #d4ecd8;
            border-radius: 10px;
            display: none;
        }
        
        .api-data-section h3 {
            color: #1a5f23;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c5e1c9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-data-section h3 i {
            font-size: 1.5rem;
        }
        
        .api-data-container {
            padding: 10px;
        }
        
        .api-data-item {
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .api-data-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .api-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            flex-wrap: wrap; /* Added to handle mobile better */
            gap: 10px;
        }
        
        .api-data-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .api-data-header h4 {
            color: #1a5f23;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .view-toggle-btn {
            background-color: #e1f0e3;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-toggle-btn:hover {
            background-color: #d1e8d4;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 95, 35, 0.1);
        }
        
        .api-data-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #1a5f23;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .api-data-details p {
            margin-bottom: 10px;
            color: #555;
            line-height: 1.5;
        }
        
        .api-data-details .timestamp {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
            margin-top: 15px;
        }
        
        .api-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .api-error {
            background-color: #fef2f2;
            border-left: 4px solid #d32f2f;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
        }
        
        .api-error h4 {
            color: #d32f2f;
            margin-bottom: 8px;
        }
        
        .refresh-api-btn {
            background-color: #e1f0e3;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .refresh-api-btn:hover {
            background-color: #d1e8d4;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 95, 35, 0.1);
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
        
        /* Feedback counter */
        .feedback-counter {
            background-color: #e1f0e3;
            color: #1a5f23;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Full feedback display */
        .full-feedback {
            background-color: #f8fdf9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px dashed #c5e1c9;
        }
        
        .full-feedback h5 {
            color: #1a5f23;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .full-feedback p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .feedback-label {
            font-weight: 600;
            color: #1a5f23;
            margin-right: 5px;
        }

        /* STATUS BADGE STYLES */
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            margin-left: 10px;
            white-space: nowrap;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .status-resolved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 10px auto;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .logo-img, .logo-fallback {
                max-width: 100px;
                max-height: 100px;
            }
            
            .logo-fallback {
                width: 100px;
                height: 100px;
                font-size: 2.2rem;
            }
            
            .api-data-section {
                padding: 15px;
                margin-top: 20px;
            }
            
            .api-data-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .view-toggle-btn {
                align-self: flex-start;
                width: 100%;
                justify-content: center;
            }
            
            .status-badge {
                margin-left: 0;
                margin-top: 5px;
                display: table; /* Forces it to sit on its own line on tiny screens */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="/image/HFA logo.jpeg" alt="HFA Logo" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='flex';">
                <div id="logoFallback" class="logo-fallback" style="display: none;">
                    HFA
                </div>
            </div>
            <h1>Halal Food Authority</h1>
            <p>All HFA Portals Feedback Form</p>
        </div>
        
        <div class="form-container">
            <div class="form-instructions">
                <h4><i class="fas fa-info-circle"></i> Instructions</h4>
                <p>Please describe any issues or challenges you encounter when using the portals, and suggest any new features or improvements you believe would be beneficial. Your feedback is extremely important, and candid criticism is strongly encouraged. The information collected through this form will be used to improve and enhance the system moving forward.</p>
                <p><strong>Note:</strong> Each feedback point can now be up to 200 characters.</p>
            </div>
            
            <div class="error-message" id="errorMessage">
                <h3><i class="fas fa-exclamation-triangle"></i> Submission Error</h3>
                <p id="errorText">There was an error submitting your feedback. Please try again.</p>
            </div>
            
            <form id="feedbackForm">
                <div class="form-group">
                    <label for="name">Name of Staff: <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="email">Email of Staff: <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required placeholder="Enter your email">
                    <div class="hint">We'll only use this to follow up on your feedback if needed</div>
                </div>
                
                <div class="feedback-item">
                    <label for="feedback1">Add Feedback 1: <span class="required">*</span></label>
                    <textarea id="feedback1" name="feedback1" maxlength="200" required placeholder="Please share your first feedback point (max 200 characters)"></textarea>
                    <div class="char-count" id="count1">
                        <span>Characters remaining: <span id="remaining1">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="button" class="add-feedback-btn" id="addFeedback2Btn">
                    <i class="fas fa-plus-circle"></i> Add Feedback 2 (Optional)
                </button>
                
                <div class="feedback-item hidden-feedback" id="feedback2Container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="feedback2">Add Feedback 2:</label>
                        <button type="button" class="remove-feedback-btn" id="removeFeedback2Btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <textarea id="feedback2" name="feedback2" maxlength="200" placeholder="Your second feedback point (optional)"></textarea>
                    <div class="char-count" id="count2">
                        <span>Characters remaining: <span id="remaining2">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="button" class="add-feedback-btn hidden-feedback" id="addFeedback3Btn">
                    <i class="fas fa-plus-circle"></i> Add Feedback 3 (Optional)
                </button>
                
                <div class="feedback-item hidden-feedback" id="feedback3Container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="feedback3">Add Feedback 3:</label>
                        <button type="button" class="remove-feedback-btn" id="removeFeedback3Btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <textarea id="feedback3" name="feedback3" maxlength="200" placeholder="Your third feedback point (optional)"></textarea>
                    <div class="char-count" id="count3">
                        <span>Characters remaining: <span id="remaining3">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> Submit Feedback
                </button>
            </form>
            
            <div class="thank-you-message" id="thankYouMessage">
                <h3><i class="fas fa-check-circle"></i> Thank You for Your Feedback!</h3>
                <p>Your feedback has been successfully submitted to the Halal Food Authority IT team. We appreciate you taking the time to help us improve our services.</p>
                <p>A confirmation email has been sent to your registered email address.</p>
                <p style="margin-top: 15px; font-style: italic;">You will be redirected in 5 seconds...</p>
            </div>
            
            <div class="api-data-section" id="apiDataSection">
                <h3><i class="fas fa-database"></i> Recent Feedback Submissions</h3>
                <div id="apiLoading" class="api-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading Feedbacks...
                </div>
                <div id="apiError" class="api-error" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h4>
                    <p id="apiErrorText">Failed to load data from API.</p>
                </div>
                <div id="apiDataContainer" class="api-data-container" style="display: none;">
                    </div>
                <button class="refresh-api-btn" id="refreshApiBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>Halal Food Authority &copy; <span id="currentYear"></span> | All feedback is confidential and will be reviewed by the IT team.</p>
            <p style="margin-top: 5px; font-size: 0.85rem;"><i class="fas fa-shield-alt"></i> Secure & Confidential</p>
        </div>
    </div>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // STATUS MANAGEMENT (Synced with Admin Page via LocalStorage)
        const STORAGE_KEY = 'hfa_admin_statuses';
        
        // Helper to get local statuses
        const getLocalStatuses = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        };

        // Helper ID generator (MUST MATCH ADMIN PAGE LOGIC)
        const generateId = (item) => {
            return item._id || `${item.timestamp || item.createdAt}-${item.email}`;
        };

        // Check if logo image exists, show fallback if not
        window.addEventListener('load', function() {
            const logoImg = document.querySelector('.logo-img');
            const logoFallback = document.getElementById('logoFallback');
            
            // If image hasn't loaded after 2 seconds, show fallback
            setTimeout(() => {
                if (logoImg && logoImg.naturalHeight === 0) {
                    logoImg.style.display = 'none';
                    if (logoFallback) logoFallback.style.display = 'flex';
                }
            }, 2000);
        });
        
        // Character count functionality for all feedback fields - UPDATED TO 200 CHARACTERS
        const feedbackFields = ['feedback1', 'feedback2', 'feedback3'];
        const MAX_CHARS = 200;
        
        feedbackFields.forEach((fieldId, index) => {
            const textarea = document.getElementById(fieldId);
            if (textarea) {
                const remainingSpan = document.getElementById(`remaining${index + 1}`);
                const charCountDiv = document.getElementById(`count${index + 1}`);
                
                // Update the max attribute to 200
                textarea.setAttribute('maxlength', MAX_CHARS);
                
                // Update the display text
                const maxSpan = charCountDiv.querySelector('span:nth-child(2)');
                if (maxSpan) maxSpan.textContent = `Max: ${MAX_CHARS}`;
                
                textarea.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    const remaining = MAX_CHARS - currentLength;
                    
                    if (remainingSpan) {
                        remainingSpan.textContent = remaining;
                    }
                    
                    // Update styling when limit is reached
                    if (charCountDiv) {
                        if (remaining <= 0) {
                            charCountDiv.classList.add('limit-reached');
                            if (remainingSpan) remainingSpan.textContent = '0';
                        } else {
                            charCountDiv.classList.remove('limit-reached');
                        }
                    }
                });
                
                // Initialize character count on page load
                const currentLength = textarea.value.length;
                const remaining = MAX_CHARS - currentLength;
                if (remainingSpan) {
                    remainingSpan.textContent = remaining;
                    
                    if (remaining <= 0) {
                        if (charCountDiv) charCountDiv.classList.add('limit-reached');
                        remainingSpan.textContent = '0';
                    }
                }
            }
        });
        
        // Show/hide functionality for additional feedback fields
        document.getElementById('addFeedback2Btn').addEventListener('click', function() {
            // Show feedback 2 field
            document.getElementById('feedback2Container').classList.remove('hidden-feedback');
            // Show add feedback 3 button
            document.getElementById('addFeedback3Btn').classList.remove('hidden-feedback');
            // Hide this button
            this.classList.add('hidden-feedback');
            
            // Focus on the textarea
            document.getElementById('feedback2').focus();
        });
        
        document.getElementById('removeFeedback2Btn').addEventListener('click', function() {
            // Hide feedback 2 field
            document.getElementById('feedback2Container').classList.add('hidden-feedback');
            // Clear the textarea
            document.getElementById('feedback2').value = '';
            // Reset character count
            document.getElementById('remaining2').textContent = MAX_CHARS;
            document.getElementById('count2').classList.remove('limit-reached');
            // Show add feedback 2 button again
            document.getElementById('addFeedback2Btn').classList.remove('hidden-feedback');
            // Hide feedback 3 if it's visible
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            document.getElementById('feedback3').value = '';
            document.getElementById('remaining3').textContent = MAX_CHARS;
            document.getElementById('count3').classList.remove('limit-reached');
            // Hide add feedback 3 button
            document.getElementById('addFeedback3Btn').classList.add('hidden-feedback');
        });
        
        document.getElementById('addFeedback3Btn').addEventListener('click', function() {
            // Show feedback 3 field
            document.getElementById('feedback3Container').classList.remove('hidden-feedback');
            // Hide this button
            this.classList.add('hidden-feedback');
            
            // Focus on the textarea
            document.getElementById('feedback3').focus();
        });
        
        document.getElementById('removeFeedback3Btn').addEventListener('click', function() {
            // Hide feedback 3 field
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            // Clear the textarea
            document.getElementById('feedback3').value = '';
            // Reset character count
            document.getElementById('remaining3').textContent = MAX_CHARS;
            document.getElementById('count3').classList.remove('limit-reached');
            // Show add feedback 3 button again
            document.getElementById('addFeedback3Btn').classList.remove('hidden-feedback');
        });
        
        // Add input validation for name field (letters and spaces only)
        document.getElementById('name').addEventListener('input', function() {
            this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
        });
        
        // Form submission handling with API integration
        document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Hide any previous error messages
            document.getElementById('errorMessage').style.display = 'none';
            
            // Basic validation
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const feedback1 = document.getElementById('feedback1').value.trim();
            const feedback2 = document.getElementById('feedback2').value.trim();
            const feedback3 = document.getElementById('feedback3').value.trim();
            
            if (!name || !email || !feedback1) {
                showError('Please fill in all required fields (Name, Email, and at least one feedback point).');
                return;
            }
            
            // Email validation
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                showError('Please enter a valid email address.');
                return;
            }
            
            // Prepare the data for API
            const feedbackData = {
                name: name,
                email: email,
                feedback1: feedback1,
                feedback2: feedback2 || null,
                feedback3: feedback3 || null,
                timestamp: new Date().toISOString()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('https://hfa-backend.onrender.com/api/v1/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    // Show thank you message
                    document.getElementById('feedbackForm').style.display = 'none';
                    document.getElementById('thankYouMessage').style.display = 'block';
                    
                    // Refresh the API data display
                    fetchAPIData();
                    
                    // Reset form after 5 seconds
                    setTimeout(() => {
                        resetForm(submitBtn, originalText);
                    }, 5000);
                    
                } else {
                    // Try to get error message from response
                    let errorMsg = 'Failed to submit feedback. Please try again.';
                    try {
                        const errorResult = await response.json();
                        if (errorResult.message) {
                            errorMsg = errorResult.message;
                        }
                    } catch (e) {
                        // If response is not JSON, use status text
                        errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Show error message
                document.getElementById('errorText').textContent = error.message || 'Sorry, there was an error submitting your feedback. Please check your connection and try again.';
                document.getElementById('errorMessage').style.display = 'block';
                
                // Scroll to error message
                document.getElementById('errorMessage').scrollIntoView({ behavior: 'smooth' });
                
                // Reset button
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to Submit';
                submitBtn.classList.add('error');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('error');
                    submitBtn.disabled = false;
                }, 3000);
            }
        });
        
        // Function to show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to reset the form
        function resetForm(submitBtn, originalText) {
            document.getElementById('feedbackForm').reset();
            document.getElementById('feedbackForm').style.display = 'block';
            document.getElementById('thankYouMessage').style.display = 'none';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            submitBtn.classList.remove('error');
            
            // Reset character counts
            feedbackFields.forEach((fieldId, index) => {
                const remainingSpan = document.getElementById(`remaining${index + 1}`);
                const charCountDiv = document.getElementById(`count${index + 1}`);
                if (remainingSpan) remainingSpan.textContent = MAX_CHARS;
                if (charCountDiv) charCountDiv.classList.remove('limit-reached');
            });
            
            // Hide additional feedback fields
            document.getElementById('feedback2Container').classList.add('hidden-feedback');
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            document.getElementById('addFeedback3Btn').classList.add('hidden-feedback');
            document.getElementById('addFeedback2Btn').classList.remove('hidden-feedback');
            
            // Hide error message if visible
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        // API Data Fetching and Display Functionality with toggle view
        async function fetchAPIData() {
            const apiDataSection = document.getElementById('apiDataSection');
            const apiLoading = document.getElementById('apiLoading');
            const apiError = document.getElementById('apiError');
            const apiDataContainer = document.getElementById('apiDataContainer');
            const apiErrorText = document.getElementById('apiErrorText');
            
            // Show loading state
            apiLoading.style.display = 'block';
            apiError.style.display = 'none';
            apiDataContainer.style.display = 'none';
            
            try {
                // Fetch data from API
                const response = await fetch('https://hfa-backend.onrender.com/api/v1/message');
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Hide loading
                apiLoading.style.display = 'none';
                
                // Show the API section
                apiDataSection.style.display = 'block';
                
                // Clear previous data
                apiDataContainer.innerHTML = '';
                
                // Get saved statuses from Local Storage
                const localStatuses = getLocalStatuses();

                // Check if data exists and is an array
                if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                    
                    // Sort data (Newest First)
                    const sortedData = data.data.sort((a, b) => {
                        return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
                    });

                    // Display each item with toggle functionality
                    sortedData.forEach((item, index) => {
                        const dataItem = document.createElement('div');
                        dataItem.className = 'api-data-item';
                        
                        // Format the data for display
                        const name = item.name || 'Anonymous';
                        const email = item.email || 'No email provided';
                        const feedback1 = item.feedback1 || 'No feedback provided';
                        const feedback2 = item.feedback2 || 'Not provided';
                        const feedback3 = item.feedback3 || 'Not provided';

                        // --- STATUS LOGIC ---
                        // Generate same ID as Admin page
                        const uniqueId = generateId(item);
                        // Get status or default to pending
                        const status = localStatuses[uniqueId] || 'pending';
                        
                        // Status text mapping
                        let statusText = 'Pending';
                        if (status === 'in-progress') statusText = 'In Progress';
                        if (status === 'resolved') statusText = 'Resolved';
                        // --------------------
                        
                        // Format timestamp
                        let timestamp = 'Unknown date';
                        if (item.timestamp || item.createdAt) {
                            const date = new Date(item.timestamp || item.createdAt);
                            timestamp = date.toLocaleString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                        
                        // Count how many feedbacks are provided
                        let feedbackCount = 1; // feedback1 is always required
                        if (feedback2 && feedback2 !== 'Not provided' && feedback2.trim() !== '') feedbackCount++;
                        if (feedback3 && feedback3 !== 'Not provided' && feedback3.trim() !== '') feedbackCount++;
                        
                        // Create HTML for the data item with toggle functionality
                        dataItem.innerHTML = `
                            <div class="api-data-header" onclick="toggleFeedbackDetails(${index})">
                                <div class="api-data-header-left">
                                    <h4>
                                        ${name}
                                        <span class="feedback-counter">${feedbackCount} feedback${feedbackCount !== 1 ? 's' : ''}</span>
                                        <span class="status-badge status-${status}">${statusText}</span>
                                    </h4>
                                </div>
                                <button class="view-toggle-btn" id="viewToggle${index}">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </div>
                            <div class="api-data-details" id="feedbackDetails${index}">
                                <p><span class="feedback-label">Email:</span> ${email}</p>
                                
                                <div class="full-feedback">
                                    <h5>Full Feedback Details:</h5>
                                    <p><span class="feedback-label">Feedback 1:</span> ${feedback1}</p>
                                    ${feedback2 && feedback2 !== 'Not provided' && feedback2.trim() !== '' ? 
                                        `<p><span class="feedback-label">Feedback 2:</span> ${feedback2}</p>` : ''}
                                    ${feedback3 && feedback3 !== 'Not provided' && feedback3.trim() !== '' ? 
                                        `<p><span class="feedback-label">Feedback 3:</span> ${feedback3}</p>` : ''}
                                </div>
                                
                                <p class="timestamp"><i class="far fa-clock"></i> Submitted: ${timestamp}</p>
                            </div>
                        `;
                        
                        apiDataContainer.appendChild(dataItem);
                    });
                    
                    // Show the container
                    apiDataContainer.style.display = 'block';
                } else {
                    // No data available
                    const noDataMessage = document.createElement('div');
                    noDataMessage.className = 'no-data';
                    noDataMessage.innerHTML = `
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; color: #ccc;"></i>
                        <p>No feedback submissions found in the database.</p>
                        <p>Be the first to submit feedback!</p>
                    `;
                    apiDataContainer.appendChild(noDataMessage);
                    apiDataContainer.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error fetching API data:', error);
                
                // Hide loading and show error
                apiLoading.style.display = 'none';
                
                // Show the API section even with error
                apiDataSection.style.display = 'block';
                
                // Set error message
                apiErrorText.textContent = error.message || 'Unable to connect to the server. Please try again later.';
                apiError.style.display = 'block';
            }
        }
        
        // Toggle function for showing/hiding feedback details
        window.toggleFeedbackDetails = function(index) {
            const detailsElement = document.getElementById(`feedbackDetails${index}`);
            const toggleButton = document.getElementById(`viewToggle${index}`);
            
            if (detailsElement.style.display === 'block') {
                // Hide details
                detailsElement.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i> View Details';
            } else {
                // Show details
                detailsElement.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
            }
        };
        
        // Add refresh button functionality
        document.getElementById('refreshApiBtn').addEventListener('click', fetchAPIData);
        
        // Initial fetch of API data when page loads
        document.addEventListener('DOMContentLoaded', fetchAPIData);
        
        // Optional: Add a function to handle network errors more gracefully
        window.addEventListener('online', () => {
            console.log('Network connection restored');
            // Try to fetch API data again if we're online
            fetchAPIData();
        });
        
        window.addEventListener('offline', () => {
            showError('You are currently offline. Please check your internet connection and try again.');
        });
    </script>
</body>
</html>