<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halal Food Authority - Staff Feedback</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/image/HFA logo.jpeg" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            background-image: linear-gradient(to bottom, #f5f9fc, #e8f0f7);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background-color: #1a5f23;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            margin-top: 15px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo-img {
            max-width: 120px;
            max-height: 120px;
            background-color: white;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo-fallback {
            background-color: white;
            color: #1a5f23;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid white;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a5f23;
        }
        
        input, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #1a5f23;
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }
        
        .char-count {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .char-count.limit-reached {
            color: #d32f2f;
        }
        
        .feedback-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eaeaea;
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }
        
        .submit-btn {
            background-color: #1a5f23;
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover:not(:disabled) {
            background-color: #13461a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 95, 35, 0.2);
        }
        
        .submit-btn:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .submit-btn.error {
            background-color: #d32f2f;
        }
        
        .add-feedback-btn {
            background-color: #f0f7f1;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 12px 20px;
            font-size: 0.95rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 10px 0 20px 0;
            width: 100%;
        }
        
        .add-feedback-btn:hover {
            background-color: #e1f0e3;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(26, 95, 35, 0.1);
        }
        
        .required {
            color: #d32f2f;
        }
        
        .hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .thank-you-message {
            display: none;
            background-color: #f1f8e9;
            border-left: 5px solid #1a5f23;
            padding: 25px;
            margin-top: 30px;
            border-radius: 8px;
        }
        
        .thank-you-message h3 {
            color: #1a5f23;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .thank-you-message h3 i {
            font-size: 1.8rem;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #fafafa;
        }
        
        .form-instructions {
            background-color: #f8fdf9;
            border: 1px solid #d4ecd8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        
        .form-instructions h4 {
            color: #1a5f23;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hidden-feedback {
            display: none;
        }
        
        .remove-feedback-btn {
            background-color: #fef2f2;
            color: #d32f2f;
            border: 1px solid #fecaca;
            padding: 8px 15px;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .remove-feedback-btn:hover {
            background-color: #fee2e2;
        }
        
        .error-message {
            background-color: #fef2f2;
            border-left: 5px solid #d32f2f;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .error-message h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* API Data Display Section */
        .api-data-section {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8fdf9;
            border: 1px solid #d4ecd8;
            border-radius: 10px;
            display: none;
        }
        
        .api-data-section h3 {
            color: #1a5f23;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c5e1c9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-data-section h3 i {
            font-size: 1.5rem;
        }
        
        /* Search Box Styles */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-container input {
            padding-left: 45px; /* Space for search icon */
            border: 1px solid #c5e1c9;
            background-color: white;
            height: 50px;
            font-size: 1rem;
        }
        
        .search-container input:focus {
            border-color: #1a5f23;
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #1a5f23;
            font-size: 1.1rem;
            pointer-events: none;
        }

        .api-data-container {
            padding: 10px;
        }
        
        .api-data-item {
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .api-data-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .api-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .api-data-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .api-data-header h4 {
            color: #1a5f23;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .view-toggle-btn {
            background-color: #e1f0e3;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-toggle-btn:hover {
            background-color: #d1e8d4;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 95, 35, 0.1);
        }
        
        .api-data-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #1a5f23;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .api-data-details p {
            margin-bottom: 10px;
            color: #555;
            line-height: 1.5;
        }
        
        .api-data-details .timestamp {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
            margin-top: 15px;
        }
        
        .api-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .api-error {
            background-color: #fef2f2;
            border-left: 4px solid #d32f2f;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
        }
        
        .api-error h4 {
            color: #d32f2f;
            margin-bottom: 8px;
        }
        
        .refresh-api-btn {
            background-color: #e1f0e3;
            color: #1a5f23;
            border: 1px solid #c5e1c9;
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .refresh-api-btn:hover {
            background-color: #d1e8d4;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(26, 95, 35, 0.1);
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
        
        /* Feedback counter */
        .feedback-counter {
            background-color: #e1f0e3;
            color: #1a5f23;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Full feedback display */
        .full-feedback {
            background-color: #f8fdf9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px dashed #c5e1c9;
        }
        
        .full-feedback h5 {
            color: #1a5f23;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        /* Detailed Feedback Row styling */
        .feedback-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        .feedback-detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .feedback-text-content {
            flex-grow: 1;
            font-size: 0.95rem;
        }
        
        .feedback-label {
            font-weight: 700;
            color: #1a5f23;
            margin-right: 5px;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        /* STATUS BADGE STYLES */
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            display: inline-block;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .status-resolved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 600px) {
            .container { margin: 10px auto; border-radius: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8rem; }
            .form-container { padding: 20px; }
            .logo-img, .logo-fallback { max-width: 100px; max-height: 100px; }
            .logo-fallback { width: 100px; height: 100px; font-size: 2.2rem; }
            .api-data-section { padding: 15px; margin-top: 20px; }
            .api-data-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .view-toggle-btn { align-self: flex-start; width: 100%; justify-content: center; }
            
            /* Stack badge below text on mobile */
            .feedback-detail-row { flex-direction: column; gap: 5px; }
            .status-badge { align-self: flex-start; margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="/image/HFA logo.jpeg" alt="HFA Logo" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='flex';">
                <div id="logoFallback" class="logo-fallback" style="display: none;">
                    HFA
                </div>
            </div>
            <h1>Halal Food Authority</h1>
            <p>All HFA Portals Feedback Form</p>
        </div>
        
        <div class="form-container">
            <div class="form-instructions">
                <h4><i class="fas fa-info-circle"></i> Instructions</h4>
                <p>Please describe any issues or challenges you encounter when using the portals, and suggest any new features or improvements you believe would be beneficial. Your feedback is extremely important, and candid criticism is strongly encouraged. The information collected through this form will be used to improve and enhance the system moving forward.</p>
                <p><strong>Note:</strong> Each feedback point can now be up to 200 characters.</p>
            </div>
            
            <div class="error-message" id="errorMessage">
                <h3><i class="fas fa-exclamation-triangle"></i> Submission Error</h3>
                <p id="errorText">There was an error submitting your feedback. Please try again.</p>
            </div>
            
            <form id="feedbackForm">
                <div class="form-group">
                    <label for="name">Name of Staff: <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="email">Email of Staff: <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required placeholder="Enter your email">
                    <div class="hint">We'll only use this to follow up on your feedback if needed</div>
                </div>
                
                <div class="feedback-item">
                    <label for="feedback1">Add Feedback 1: <span class="required">*</span></label>
                    <textarea id="feedback1" name="feedback1" maxlength="200" required placeholder="Please share your first feedback point (max 200 characters)"></textarea>
                    <div class="char-count" id="count1">
                        <span>Characters remaining: <span id="remaining1">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="button" class="add-feedback-btn" id="addFeedback2Btn">
                    <i class="fas fa-plus-circle"></i> Add Feedback 2 (Optional)
                </button>
                
                <div class="feedback-item hidden-feedback" id="feedback2Container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="feedback2">Add Feedback 2:</label>
                        <button type="button" class="remove-feedback-btn" id="removeFeedback2Btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <textarea id="feedback2" name="feedback2" maxlength="200" placeholder="Your second feedback point (optional)"></textarea>
                    <div class="char-count" id="count2">
                        <span>Characters remaining: <span id="remaining2">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="button" class="add-feedback-btn hidden-feedback" id="addFeedback3Btn">
                    <i class="fas fa-plus-circle"></i> Add Feedback 3 (Optional)
                </button>
                
                <div class="feedback-item hidden-feedback" id="feedback3Container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="feedback3">Add Feedback 3:</label>
                        <button type="button" class="remove-feedback-btn" id="removeFeedback3Btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <textarea id="feedback3" name="feedback3" maxlength="200" placeholder="Your third feedback point (optional)"></textarea>
                    <div class="char-count" id="count3">
                        <span>Characters remaining: <span id="remaining3">200</span></span>
                        <span>Max: 200</span>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> Submit Feedback
                </button>
            </form>
            
            <div class="thank-you-message" id="thankYouMessage">
                <h3><i class="fas fa-check-circle"></i> Thank You for Your Feedback!</h3>
                <p>Your feedback has been successfully submitted to the Halal Food Authority IT team. We appreciate you taking the time to help us improve our services.</p>
                <p>A confirmation email has been sent to your registered email address.</p>
                <p style="margin-top: 15px; font-style: italic;">You will be redirected in 5 seconds...</p>
            </div>
            
            <div class="api-data-section" id="apiDataSection">
                <h3><i class="fas fa-database"></i> Recent Feedback Submissions</h3>
                
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search by staff name...">
                </div>

                <div id="apiLoading" class="api-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading Feedbacks...
                </div>
                <div id="apiError" class="api-error" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h4>
                    <p id="apiErrorText">Failed to load data from API.</p>
                </div>
                <div id="apiDataContainer" class="api-data-container" style="display: none;">
                </div>
                <button class="refresh-api-btn" id="refreshApiBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>Halal Food Authority &copy; <span id="currentYear"></span> | All feedback is confidential and will be reviewed by the IT team.</p>
            <p style="margin-top: 5px; font-size: 0.85rem;"><i class="fas fa-shield-alt"></i> Secure & Confidential</p>
        </div>
    </div>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // --- GLOBAL VARIABLES ---
        const STORAGE_KEY = 'hfa_admin_statuses_detailed';
        let allFeedbackData = []; // Store fetched data for searching

        // --- HELPERS ---
        const getLocalStatuses = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        };

        const generateId = (item) => {
            return item._id || `${item.timestamp || item.createdAt}-${item.email}`;
        };

        // Logo Fallback
        window.addEventListener('load', function() {
            const logoImg = document.querySelector('.logo-img');
            const logoFallback = document.getElementById('logoFallback');
            setTimeout(() => {
                if (logoImg && logoImg.naturalHeight === 0) {
                    logoImg.style.display = 'none';
                    if (logoFallback) logoFallback.style.display = 'flex';
                }
            }, 2000);
        });
        
        // Form Logic
        const feedbackFields = ['feedback1', 'feedback2', 'feedback3'];
        const MAX_CHARS = 200;
        
        feedbackFields.forEach((fieldId, index) => {
            const textarea = document.getElementById(fieldId);
            if (textarea) {
                const remainingSpan = document.getElementById(`remaining${index + 1}`);
                const charCountDiv = document.getElementById(`count${index + 1}`);
                textarea.setAttribute('maxlength', MAX_CHARS);
                if (charCountDiv.querySelector('span:nth-child(2)')) charCountDiv.querySelector('span:nth-child(2)').textContent = `Max: ${MAX_CHARS}`;
                
                textarea.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    const remaining = MAX_CHARS - currentLength;
                    if (remainingSpan) remainingSpan.textContent = remaining;
                    if (charCountDiv) {
                        if (remaining <= 0) {
                            charCountDiv.classList.add('limit-reached');
                            if (remainingSpan) remainingSpan.textContent = '0';
                        } else {
                            charCountDiv.classList.remove('limit-reached');
                        }
                    }
                });
                
                // Initialize
                if (remainingSpan) remainingSpan.textContent = MAX_CHARS;
            }
        });
        
        // Show/Hide Fields Logic
        document.getElementById('addFeedback2Btn').addEventListener('click', function() {
            document.getElementById('feedback2Container').classList.remove('hidden-feedback');
            document.getElementById('addFeedback3Btn').classList.remove('hidden-feedback');
            this.classList.add('hidden-feedback');
            document.getElementById('feedback2').focus();
        });
        
        document.getElementById('removeFeedback2Btn').addEventListener('click', function() {
            document.getElementById('feedback2Container').classList.add('hidden-feedback');
            document.getElementById('feedback2').value = '';
            document.getElementById('remaining2').textContent = MAX_CHARS;
            document.getElementById('addFeedback2Btn').classList.remove('hidden-feedback');
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            document.getElementById('feedback3').value = '';
            document.getElementById('addFeedback3Btn').classList.add('hidden-feedback');
        });
        
        document.getElementById('addFeedback3Btn').addEventListener('click', function() {
            document.getElementById('feedback3Container').classList.remove('hidden-feedback');
            this.classList.add('hidden-feedback');
            document.getElementById('feedback3').focus();
        });
        
        document.getElementById('removeFeedback3Btn').addEventListener('click', function() {
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            document.getElementById('feedback3').value = '';
            document.getElementById('remaining3').textContent = MAX_CHARS;
            document.getElementById('addFeedback3Btn').classList.remove('hidden-feedback');
        });
        
        document.getElementById('name').addEventListener('input', function() {
            this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
        });
        
        // Submit Logic
        document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            document.getElementById('errorMessage').style.display = 'none';
            
            const feedbackData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                feedback1: document.getElementById('feedback1').value.trim(),
                feedback2: document.getElementById('feedback2').value.trim() || null,
                feedback3: document.getElementById('feedback3').value.trim() || null,
                timestamp: new Date().toISOString()
            };
            
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('https://hfa-backend.onrender.com/api/v1/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });

                if (response.ok) {
                    document.getElementById('feedbackForm').style.display = 'none';
                    document.getElementById('thankYouMessage').style.display = 'block';
                    fetchAPIData();
                    setTimeout(() => { resetForm(submitBtn, originalText); }, 5000);
                } else {
                    throw new Error('Failed to submit feedback.');
                }
            } catch (error) {
                showError(error.message || 'Submission failed.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }
        
        function resetForm(submitBtn, originalText) {
            document.getElementById('feedbackForm').reset();
            document.getElementById('feedbackForm').style.display = 'block';
            document.getElementById('thankYouMessage').style.display = 'none';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            document.getElementById('feedback2Container').classList.add('hidden-feedback');
            document.getElementById('feedback3Container').classList.add('hidden-feedback');
            document.getElementById('addFeedback3Btn').classList.add('hidden-feedback');
            document.getElementById('addFeedback2Btn').classList.remove('hidden-feedback');
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        // --- API & SEARCH LOGIC ---
        
        async function fetchAPIData() {
            const apiDataSection = document.getElementById('apiDataSection');
            const apiLoading = document.getElementById('apiLoading');
            const apiError = document.getElementById('apiError');
            const apiDataContainer = document.getElementById('apiDataContainer');
            
            apiLoading.style.display = 'block';
            apiError.style.display = 'none';
            apiDataContainer.style.display = 'none';
            
            try {
                const response = await fetch('https://hfa-backend.onrender.com/api/v1/message');
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                apiLoading.style.display = 'none';
                apiDataSection.style.display = 'block';
                
                if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                    // Store and sort data
                    allFeedbackData = data.data.sort((a, b) => new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt));
                    // Initial Render
                    renderFeedbackList(allFeedbackData);
                } else {
                    apiDataContainer.innerHTML = `<div class="no-data"><p>No feedback found.</p></div>`;
                    apiDataContainer.style.display = 'block';
                }
            } catch (error) {
                apiLoading.style.display = 'none';
                apiDataSection.style.display = 'block';
                document.getElementById('apiErrorText').textContent = 'Unable to connect to server.';
                apiError.style.display = 'block';
            }
        }

        function renderFeedbackList(dataToRender) {
            const apiDataContainer = document.getElementById('apiDataContainer');
            apiDataContainer.innerHTML = '';
            const localStatuses = getLocalStatuses();

            if (dataToRender.length === 0) {
                apiDataContainer.innerHTML = `<div class="no-data"><p>No results found for your search.</p></div>`;
                apiDataContainer.style.display = 'block';
                return;
            }

            dataToRender.forEach((item, index) => {
                const dataItem = document.createElement('div');
                dataItem.className = 'api-data-item';
                
                const baseId = generateId(item);
                const date = new Date(item.timestamp || item.createdAt);
                const timestamp = date.toLocaleString('en-US');
                
                // Helper for badges
                const getBadge = (key) => {
                    const status = localStatuses[key] || 'pending';
                    let label = 'Pending';
                    if (status === 'in-progress') label = 'In Progress';
                    if (status === 'resolved') label = 'Resolved';
                    return `<span class="status-badge status-${status}">${label}</span>`;
                };
                
                let count = 1;
                if (item.feedback2 && item.feedback2 !== 'Not provided' && item.feedback2.trim() !== '') count++;
                if (item.feedback3 && item.feedback3 !== 'Not provided' && item.feedback3.trim() !== '') count++;
                
                // Build Details HTML
                let detailsHTML = `
                    <div class="feedback-detail-row">
                        <div class="feedback-text-content"><span class="feedback-label">1:</span> ${item.feedback1}</div>
                        ${getBadge(baseId + '_f1')}
                    </div>
                `;

                if (item.feedback2 && item.feedback2 !== 'Not provided' && item.feedback2.trim() !== '') {
                    detailsHTML += `
                        <div class="feedback-detail-row">
                            <div class="feedback-text-content"><span class="feedback-label">2:</span> ${item.feedback2}</div>
                            ${getBadge(baseId + '_f2')}
                        </div>
                    `;
                }

                if (item.feedback3 && item.feedback3 !== 'Not provided' && item.feedback3.trim() !== '') {
                    detailsHTML += `
                        <div class="feedback-detail-row">
                            <div class="feedback-text-content"><span class="feedback-label">3:</span> ${item.feedback3}</div>
                            ${getBadge(baseId + '_f3')}
                        </div>
                    `;
                }

                dataItem.innerHTML = `
                    <div class="api-data-header" onclick="toggleFeedbackDetails(${index})">
                        <div class="api-data-header-left">
                            <h4>
                                ${item.name || 'Anonymous'}
                                <span class="feedback-counter">${count} feedback${count !== 1 ? 's' : ''}</span>
                            </h4>
                        </div>
                        <button class="view-toggle-btn" id="viewToggle${index}">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                    <div class="api-data-details" id="feedbackDetails${index}">
                        <p><span class="feedback-label">Email:</span> ${item.email || 'No email'}</p>
                        <div class="full-feedback">
                            <h5>Feedback Details & Status:</h5>
                            ${detailsHTML}
                        </div>
                        <p class="timestamp"><i class="far fa-clock"></i> Submitted: ${timestamp}</p>
                    </div>
                `;
                
                apiDataContainer.appendChild(dataItem);
            });
            apiDataContainer.style.display = 'block';
        }

        // Search Listener
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = allFeedbackData.filter(item => 
                (item.name || '').toLowerCase().includes(searchTerm)
            );
            renderFeedbackList(filteredData);
        });
        
        window.toggleFeedbackDetails = function(index) {
            const detailsElement = document.getElementById(`feedbackDetails${index}`);
            const toggleButton = document.getElementById(`viewToggle${index}`);
            
            if (detailsElement.style.display === 'block') {
                detailsElement.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i> View Details';
            } else {
                detailsElement.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
            }
        };
        
        document.getElementById('refreshApiBtn').addEventListener('click', fetchAPIData);
        document.addEventListener('DOMContentLoaded', fetchAPIData);
    </script>
</body>
</html>