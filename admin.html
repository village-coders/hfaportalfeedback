<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFA Admin Portal - Detailed Feedback Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f2f5; color: #333; display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background-color: #1a5f23; color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-links { list-style: none; padding: 20px 0; }
        .nav-links li a { display: flex; align-items: center; padding: 15px 25px; color: rgba(255,255,255,0.8); text-decoration: none; gap: 15px; }
        .nav-links li a:hover, .nav-links li a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #4caf50; }

        /* Main Content */
        .main-content { flex-grow: 1; margin-left: 250px; padding: 30px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Content Card */
        .content-card { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { background: none; border: 1px solid #ddd; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: #666; transition: 0.3s; }
        .refresh-btn:hover { background: #f5f5f5; color: #1a5f23; }

        /* Feedback Item Styles */
        .feedback-item { border-bottom: 1px solid #eee; padding: 20px; }
        .feedback-header { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .user-info h4 { color: #333; }
        .user-info span { font-size: 0.85rem; color: #777; }
        .timestamp { font-size: 0.8rem; color: #888; float: right; margin-top: -35px; }

        /* Individual Feedback Rows */
        .feedback-row { 
            display: flex; 
            flex-direction: column; 
            background-color: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border-left: 4px solid #ccc;
        }
        
        .feedback-content { margin-bottom: 10px; font-size: 0.95rem; line-height: 1.5; }
        .feedback-label { font-weight: 700; color: #1a5f23; margin-right: 5px; font-size: 0.85rem; text-transform: uppercase; }

        /* Status Select Styling */
        .status-wrapper { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .status-label { font-size: 0.8rem; color: #666; font-weight: 600; }
        
        select.status-select {
            padding: 6px 12px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            outline: none;
        }

        /* Status Colors */
        .status-select.pending { background-color: #fff3cd; color: #856404; border-color: #ffeeba; border-left: 4px solid #856404; }
        .status-select.in-progress { background-color: #cce5ff; color: #004085; border-color: #b8daff; border-left: 4px solid #004085; }
        .status-select.resolved { background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-left: 4px solid #155724; }

        .loading, .no-data { padding: 40px; text-align: center; color: #666; }

        @media (max-width: 768px) {
            .sidebar { width: 70px; overflow: hidden; }
            .sidebar h2, .nav-links span { display: none; }
            .main-content { margin-left: 70px; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h3>HFA Admin</h3>
        </div>
        <ul class="nav-links">
            <li><a href="#" class="active"><i class="fas fa-columns"></i> <span>Dashboard</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Feedback Management</h1>
        </div>

        <div class="content-card">
            <div class="card-header">
                <h3><i class="fas fa-tasks"></i> Manage Feedback Statuses</h3>
                <button class="refresh-btn" onclick="loadFeedback()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            <div id="feedbackContainer">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'hfa_admin_statuses_detailed';
        
        // Helper to get statuses
        const getLocalStatuses = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        };

        // Helper to save specific status (e.g., ID_f1, ID_f2)
        const saveStatus = (uniqueKey, status) => {
            const statuses = getLocalStatuses();
            statuses[uniqueKey] = status;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(statuses));
        };

        const generateId = (item) => item._id || `${item.timestamp || item.createdAt}-${item.email}`;

        async function loadFeedback() {
            const container = document.getElementById('feedbackContainer');
            const localStatuses = getLocalStatuses();
            
            try {
                const response = await fetch('https://hfa-backend.onrender.com/api/v1/message');
                const result = await response.json();
                
                if (!result.data || result.data.length === 0) {
                    container.innerHTML = '<div class="no-data">No data found.</div>';
                    return;
                }

                const sortedData = result.data.sort((a, b) => new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt));
                container.innerHTML = '';

                sortedData.forEach(item => {
                    const baseId = generateId(item);
                    const dateStr = new Date(item.timestamp || item.createdAt).toLocaleString();

                    // --- GENERATE HTML FOR INDIVIDUAL FEEDBACKS ---
                    
                    // Feedback 1 (Always exists)
                    const f1Key = `${baseId}_f1`;
                    const f1Status = localStatuses[f1Key] || 'pending';
                    
                    let feedbacksHTML = `
                        <div class="feedback-row">
                            <div class="feedback-content">
                                <span class="feedback-label">Point 1:</span> ${item.feedback1}
                            </div>
                            <div class="status-wrapper">
                                <span class="status-label">Status:</span>
                                <select class="status-select ${f1Status}" onchange="changeStatus(this, '${f1Key}')">
                                    <option value="pending" ${f1Status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in-progress" ${f1Status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="resolved" ${f1Status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                </select>
                            </div>
                        </div>
                    `;

                    // Feedback 2 (Optional)
                    if (item.feedback2 && item.feedback2.trim() !== '' && item.feedback2 !== 'Not provided') {
                        const f2Key = `${baseId}_f2`;
                        const f2Status = localStatuses[f2Key] || 'pending';
                        feedbacksHTML += `
                            <div class="feedback-row">
                                <div class="feedback-content">
                                    <span class="feedback-label">Point 2:</span> ${item.feedback2}
                                </div>
                                <div class="status-wrapper">
                                    <span class="status-label">Status:</span>
                                    <select class="status-select ${f2Status}" onchange="changeStatus(this, '${f2Key}')">
                                        <option value="pending" ${f2Status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="in-progress" ${f2Status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="resolved" ${f2Status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    </select>
                                </div>
                            </div>
                        `;
                    }

                    // Feedback 3 (Optional)
                    if (item.feedback3 && item.feedback3.trim() !== '' && item.feedback3 !== 'Not provided') {
                        const f3Key = `${baseId}_f3`;
                        const f3Status = localStatuses[f3Key] || 'pending';
                        feedbacksHTML += `
                            <div class="feedback-row">
                                <div class="feedback-content">
                                    <span class="feedback-label">Point 3:</span> ${item.feedback3}
                                </div>
                                <div class="status-wrapper">
                                    <span class="status-label">Status:</span>
                                    <select class="status-select ${f3Status}" onchange="changeStatus(this, '${f3Key}')">
                                        <option value="pending" ${f3Status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="in-progress" ${f3Status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="resolved" ${f3Status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    </select>
                                </div>
                            </div>
                        `;
                    }

                    // Wrap it all
                    const div = document.createElement('div');
                    div.className = 'feedback-item';
                    div.innerHTML = `
                        <div class="feedback-header">
                            <div class="user-info">
                                <h4>${item.name}</h4>
                                <span>${item.email}</span>
                            </div>
                            <div class="timestamp"><i class="far fa-clock"></i> ${dateStr}</div>
                        </div>
                        <div class="feedbacks-container">
                            ${feedbacksHTML}
                        </div>
                    `;
                    container.appendChild(div);
                });

            } catch (error) {
                container.innerHTML = '<div class="no-data">Error loading data.</div>';
            }
        }

        function changeStatus(selectElement, uniqueKey) {
            const newStatus = selectElement.value;
            selectElement.className = `status-select ${newStatus}`;
            saveStatus(uniqueKey, newStatus);
        }

        document.addEventListener('DOMContentLoaded', loadFeedback);
    </script>
</body>
</html>